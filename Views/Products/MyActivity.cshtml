@model ProductActivityDashboardViewModel
@{
    ViewData["Title"] = "My Activity";

    string FormatPrice(decimal? value)
    {
        return value.HasValue && value.Value > 0 ? $"INR {value.Value:0.##}" : "Free";
    }

    string FormatDate(DateTime value)
    {
        return value.ToLocalTime().ToString("dd MMM yyyy hh:mm tt");
    }
}

<section class="fem-hero mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
            <p class="small text-uppercase fw-semibold text-secondary mb-2">Your Dashboard</p>
            <h1 class="display-6 fw-bold mb-2">My Activity</h1>
            <p class="text-secondary mb-0">Track your active listings, sold/booked listings, and products you bought.</p>
        </div>
        <div class="text-lg-end">
            <a asp-action="Index" class="btn btn-outline-dark me-2">Go to Marketplace</a>
            <a asp-action="Create" class="btn btn-primary">List New Product</a>
        </div>
    </div>
</section>

<section class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="fem-kpi h-100">
            <div class="fem-kpi-label">Active Listings</div>
            <div class="fem-kpi-value">@Model.ActiveListings.Count</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="fem-kpi h-100">
            <div class="fem-kpi-label">Pending Approval</div>
            <div class="fem-kpi-value">@Model.PendingListings.Count</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="fem-kpi h-100">
            <div class="fem-kpi-label">Buyer Requests</div>
            <div class="fem-kpi-value">@Model.PendingBuyerRequests.Count</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="fem-kpi h-100">
            <div class="fem-kpi-label">Bought By You</div>
            <div class="fem-kpi-value">@Model.BoughtItems.Count</div>
        </div>
    </div>
</section>

<section class="fem-card p-3 p-md-4 mb-4">
    <h2 class="h5 fw-bold mb-2">How Buying Works</h2>
    <p class="mb-0 text-secondary">
        To buy/book an item: open <strong>Marketplace</strong> -> click <strong>View / Buy</strong> -> click <strong>Request Booking</strong> on product details.
        Owner can then <strong>Approve</strong> or <strong>Reject</strong> the request. Approved requests become sold and rejected requests return to marketplace.
    </p>
</section>

<section class="fem-card p-3 p-md-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 fw-bold mb-0">Active Listings</h2>
        <span class="small text-secondary">@Model.ActiveListings.Count item(s)</span>
    </div>
    @if (Model.ActiveListings.Count == 0)
    {
        <div class="empty-state">No active listings yet.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (ProductActivityItemViewModel item in Model.ActiveListings)
            {
                <div class="col-md-6 col-xl-4">
                    <article class="card h-100 border-0 fem-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge text-bg-success">Active</span>
                                <small class="text-secondary">@FormatDate(item.CreatedOnUtc)</small>
                            </div>
                            <h3 class="h6 fw-bold mb-1">@item.Title</h3>
                            <p class="meta mb-2">@item.Category | @item.ItemCondition</p>
                            <p class="meta mb-3">@item.City</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <strong>@FormatPrice(item.Price)</strong>
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-dark btn-sm">View</a>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>

<section class="fem-card p-3 p-md-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 fw-bold mb-0">Pending Approval</h2>
        <span class="small text-secondary">@Model.PendingListings.Count item(s)</span>
    </div>
    @if (Model.PendingListings.Count == 0)
    {
        <div class="empty-state">No listings are pending approval.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (ProductActivityItemViewModel item in Model.PendingListings)
            {
                <div class="col-md-6 col-xl-4">
                    <article class="card h-100 border-0 fem-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge text-bg-warning">Pending</span>
                                <small class="text-secondary">@FormatDate(item.CreatedOnUtc)</small>
                            </div>
                            <h3 class="h6 fw-bold mb-1">@item.Title</h3>
                            <p class="meta mb-2">@item.Category | @item.ItemCondition</p>
                            <p class="meta mb-3">Waiting for admin approval</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <strong>@FormatPrice(item.Price)</strong>
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-dark btn-sm">View</a>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>

<section class="fem-card p-3 p-md-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 fw-bold mb-0">Sold Listings</h2>
        <span class="small text-secondary">@Model.SoldListings.Count item(s)</span>
    </div>
    @if (Model.SoldListings.Count == 0)
    {
        <div class="empty-state">No sold listings yet.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (ProductActivityItemViewModel item in Model.SoldListings)
            {
                <div class="col-md-6 col-xl-4">
                    <article class="card h-100 border-0 fem-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge text-bg-danger">Sold / Booked</span>
                                <small class="text-secondary">@(item.SoldOnUtc.HasValue ? FormatDate(item.SoldOnUtc.Value) : "-")</small>
                            </div>
                            <h3 class="h6 fw-bold mb-1">@item.Title</h3>
                            <p class="meta mb-2">@item.Category | @item.ItemCondition</p>
                            <p class="meta mb-3">Booked by @(string.IsNullOrWhiteSpace(item.BuyerUserName) ? "Member" : item.BuyerUserName)</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center gap-2">
                                <strong>@FormatPrice(item.Price)</strong>
                                <div class="d-flex gap-2">
                                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-dark btn-sm">View</a>
                                    <form asp-action="UndoBooking" asp-route-id="@item.Id" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-primary btn-sm">Undo Booking</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>

<section class="fem-card p-3 p-md-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 fw-bold mb-0">Pending Buyer Requests</h2>
        <span class="small text-secondary">@Model.PendingBuyerRequests.Count item(s)</span>
    </div>
    @if (Model.PendingBuyerRequests.Count == 0)
    {
        <div class="empty-state">No pending buyer requests.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (ProductActivityItemViewModel item in Model.PendingBuyerRequests)
            {
                <div class="col-md-6 col-xl-4">
                    <article class="card h-100 border-0 fem-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge text-bg-warning">Pending Buyer Approval</span>
                                <small class="text-secondary">@FormatDate(item.CreatedOnUtc)</small>
                            </div>
                            <h3 class="h6 fw-bold mb-1">@item.Title</h3>
                            <p class="meta mb-2">@item.Category | @item.ItemCondition</p>
                            <p class="meta mb-3">Buyer: @(item.BuyerUserName ?? "Member")</p>
                            <div class="mt-auto d-flex flex-wrap gap-2">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-dark btn-sm">View</a>
                                <form asp-action="ApproveBooking" asp-route-id="@item.Id" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">Approve</button>
                                </form>
                                <form asp-action="RejectBooking" asp-route-id="@item.Id" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">Reject</button>
                                </form>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>

<section class="fem-card p-3 p-md-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 fw-bold mb-0">Bought By You</h2>
        <span class="small text-secondary">@Model.BoughtItems.Count item(s)</span>
    </div>
    @if (Model.BoughtItems.Count == 0)
    {
        <div class="empty-state">You have not booked any products yet.</div>
    }
    else
    {
        <div class="row g-3">
            @foreach (ProductActivityItemViewModel item in Model.BoughtItems)
            {
                <div class="col-md-6 col-xl-4">
                    <article class="card h-100 border-0 fem-card">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge @(item.IsSold ? "text-bg-success" : "text-bg-warning")">@(item.IsSold ? "Bought" : "Pending Owner Approval")</span>
                                <small class="text-secondary">@(item.SoldOnUtc.HasValue ? FormatDate(item.SoldOnUtc.Value) : FormatDate(item.CreatedOnUtc))</small>
                            </div>
                            <h3 class="h6 fw-bold mb-1">@item.Title</h3>
                            <p class="meta mb-2">@item.Category | @item.ItemCondition</p>
                            <p class="meta mb-3">Seller: @item.SellerDisplayName (@item.SellerUserName)</p>
                            <div class="mt-auto d-flex justify-content-between align-items-center">
                                <strong>@FormatPrice(item.Price)</strong>
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-dark btn-sm">View</a>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>
    }
</section>
