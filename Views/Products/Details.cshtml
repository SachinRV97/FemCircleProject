@model ProductDetailsViewModel
@{
    ViewData["Title"] = "Product Details";

    string FormatPrice(decimal? value)
    {
        return value.HasValue && value.Value > 0 ? $"INR {value.Value:0.##}" : "Free";
    }
}

<div class="mb-3">
    <a asp-action="Index" class="text-decoration-none small">&larr; Back to Marketplace</a>
</div>

@if (TempData["ProductSuccess"] is string successMessage)
{
    <div class="alert alert-success" role="alert">@successMessage</div>
}

@if (TempData["ProductError"] is string errorMessage)
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}

<section class="fem-card p-3 p-md-4">
    <div class="row g-4">
        <div class="col-lg-5">
            @if (!string.IsNullOrWhiteSpace(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="@Model.Title" class="img-fluid rounded-4 border" />
            }
            else
            {
                <div class="d-flex align-items-center justify-content-center rounded-4 border bg-light-subtle text-secondary" style="height: 300px;">
                    No image available
                </div>
            }
        </div>
        <div class="col-lg-7">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                <span class="badge text-bg-primary">@Model.ListingType</span>
                <span class="badge text-bg-light border">@Model.Category</span>
                @if (Model.IsSold)
                {
                    <span class="badge @(Model.IsBoughtByCurrentUser ? "text-bg-success" : "text-bg-danger")">@(Model.IsBoughtByCurrentUser ? "Bought" : "Sold")</span>
                }
                else if (Model.IsBookingPending)
                {
                    <span class="badge text-bg-warning">Booking Pending</span>
                }
            </div>
            <h1 class="h2 fw-bold mb-2">@Model.Title</h1>
            <p class="text-secondary mb-4">@Model.Description</p>

            <div class="row g-2 mb-4">
                <div class="col-sm-6">
                    <div class="fem-kpi">
                        <div class="fem-kpi-label">Price</div>
                        <div class="fem-kpi-value">@FormatPrice(Model.Price)</div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="fem-kpi">
                        <div class="fem-kpi-label">Condition</div>
                        <div class="fem-kpi-value fs-5">@Model.ItemCondition</div>
                    </div>
                </div>
            </div>

            <dl class="row small mb-4">
                <dt class="col-sm-4 text-secondary">Quantity</dt>
                <dd class="col-sm-8">@Model.Quantity</dd>
                <dt class="col-sm-4 text-secondary">Seller</dt>
                <dd class="col-sm-8">@Model.SellerDisplayName</dd>
                <dt class="col-sm-4 text-secondary">City</dt>
                <dd class="col-sm-8">@Model.City</dd>
                <dt class="col-sm-4 text-secondary">Posted On</dt>
                <dd class="col-sm-8">@Model.PostedOnUtc.ToLocalTime().ToString("dd MMM yyyy hh:mm tt")</dd>
                @if (Model.IsSold || Model.IsBookingPending)
                {
                    <dt class="col-sm-4 text-secondary">Booked By</dt>
                    <dd class="col-sm-8">@(Model.BoughtByUserName ?? "Member")</dd>
                    @if (Model.IsSold)
                    {
                        <dt class="col-sm-4 text-secondary">Sold On</dt>
                        <dd class="col-sm-8">@Model.SoldOnUtc?.ToLocalTime().ToString("dd MMM yyyy hh:mm tt")</dd>
                    }
                }
            </dl>

            @if (!Model.IsSold && !Model.IsBookingPending && Model.CanBook)
            {
                <form asp-action="Book" asp-route-id="@Model.Id" method="post" class="mb-3">
                    <button type="submit" class="btn btn-primary">Request Booking</button>
                </form>
            }

            @if (Model.IsBookingPending)
            {
                @if (Model.IsBookingPendingForCurrentUser)
                {
                    <div class="alert alert-info mb-3">
                        Your booking request was sent. Waiting for owner approval.
                    </div>
                }
                else if (Model.CanReviewBooking)
                {
                    <div class="alert alert-warning mb-3">
                        Booking request received from @(Model.BoughtByUserName ?? "Member"). Approve or reject this buyer.
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <form asp-action="ApproveBooking" asp-route-id="@Model.Id" method="post" class="d-inline">
                            <button type="submit" class="btn btn-success">Approve Buyer</button>
                        </form>
                        <form asp-action="RejectBooking" asp-route-id="@Model.Id" method="post" class="d-inline">
                            <button type="submit" class="btn btn-outline-danger">Reject Buyer</button>
                        </form>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-3">
                        This item already has a pending booking request and is temporarily unavailable.
                    </div>
                }
            }
            else if (Model.IsSold)
            {
                @if (Model.IsBoughtByCurrentUser)
                {
                    <div class="alert alert-success mb-3">
                        Owner approved your booking on @Model.SoldOnUtc?.ToLocalTime().ToString("dd MMM yyyy hh:mm tt").
                    </div>
                }
                else if (Model.CanUndoBooking)
                {
                    <div class="alert alert-info mb-3">
                        This item is sold to @(Model.BoughtByUserName ?? "Member"). You can relist by undoing sale.
                    </div>
                    <form asp-action="UndoBooking" asp-route-id="@Model.Id" method="post" class="mb-3">
                        <button type="submit" class="btn btn-outline-primary">Undo Booking & Relist</button>
                    </form>
                }
                else
                {
                    <div class="alert alert-warning mb-3">
                        This product is already booked by another user and is not available now.
                    </div>
                }
            }

            @if (!Model.IsSold && !Model.IsBookingPending && Model.CanManage)
            {
                <div class="d-flex flex-wrap gap-2">
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-dark">Edit</a>
                    <form asp-action="Delete" asp-route-id="@Model.Id" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete this listing?');">Delete</button>
                    </form>
                </div>
            }
        </div>
    </div>
</section>
